<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Basic Air Travel Requests</title>
  <meta name="GENERATOR" content="Blackfriday Markdown Processor v1.1" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="stylesheet" type="text/css" href="css/base.css" />
</head>
<body>

<h1>Basic Air Travel Requests</h1>

<h2>Unit 1, Lesson 2</h2>

<h3>Objective Of Lesson 2</h3>

<p>After this lesson is completed you should know how to search for available flights and price itineraries using the Travelport Universal API.</p>

<h3>Workflow</h3>

<p>This lesson, building on the <a href="index.html">previous one</a>, will allow you to do what most travel agents did in the past and what many still do today.  Their objective is to sell a trip to a customer, but to do that they need to do two basic tasks:</p>

<ul>
<li><p>Find a set of available flights that get the traveller from origin to destination (and often back)</p></li>

<li><p>Given the set of flights, determine the price of that itinerary</p></li>
</ul>

<p>Given the terminology we explained in <a href="index.html">lesson 1</a>, there are two ports that are needed to accomplish this workflow, unsurprisingly called the &ldquo;Availabilty Search&rdquo; port and the &ldquo;Price&rdquo; port.  Both of these can be accessed from the <code>AirService</code> object.</p>

<h3>Generating The Client</h3>

<p>As with the <code>Service.wsdl</code> in the previous lesson, we will need to generate the Java code to access uAPI services, this time from <code>Air.wsdl</code> in the directory <code>wsdl/air_v18_0</code>.  After you have generated the code, you will have many more packages in your project (hitting &ldquo;refresh&rdquo; or &ldquo;F5&rdquo; on your <code>src</code> folder is probably a good idea).  The <a href="https://github.com/iansmith/travelport-uapi-tutorial/blob/master/src/com/travelport/service/air_v18_0/AirService.java">AirService</a> object&rsquo;s (generated) implementation is part of the package <a href="(https://github.com/iansmith/travelport-uapi-tutorial/blob/master/src/com/travelport/service/air_v18_0/">com.travelport.service.air_v18_0</a>.</p>

<h3>Why All The Packages And Code?</h3>

<p>The reason for all the generated code&ndash;tens of thousands of lines of it&ndash;resulting running &ldquo;generate client&rdquo; on <code>Air.wsdl</code> is that WSDL files may reference other WSDL files as well as schema files (in XSD files).  The <code>Air.wsdl</code> is the top of a large pyramid of different objects and since they all can be referenced in a chain that starts from <code>Air.wsdl</code> the CXF framework is obligated to generate code for them. CXF must generate Java code for all <em>reachable</em> types starting at <code>Air.wsdl</code> and proceeding through any number of requests and responses; in this specific case, the set of reachable types includes classes describing the amenities available in a particular hotel and the details of the taxes on a particular rail journey!</p>

<h3>Goal</h3>

<p>The class <a href="https://github.com/iansmith/travelport-uapi-tutorial/blob/master/src/com/travelport/uapi/unit1/Lesson2.java">Lesson2</a> can output itineraries for a given city pair, in this case Paris to Chattanooga Tennessee, USA, in a form like this:</p>

<pre><code>Price:GBP941.70 [BasePrice EUR760.00, Taxes GBP315.70]
AF#682 from CDG to ATL at 2012-06-22T10:55:00.000+02:00
AF#8468 from ATL to CHA at 2012-06-22T16:05:00.000-04:00
DL#5023 from CHA to ATL at 2012-06-29T16:06:00.000-04:00
DL#8517 from ATL to CDG at 2012-06-29T17:55:00.000-04:00
-----------
Price:GBP3594.70 [BasePrice EUR3998.00, Taxes GBP301.70]
UA#2331 from CDG to CLT at 2012-06-22T11:10:00.000+02:00
US#3568 from CLT to CHA at 2012-06-22T16:25:00.000-04:00
DL#5023 from CHA to ATL at 2012-06-29T16:06:00.000-04:00
DL#8517 from ATL to CDG at 2012-06-29T17:55:00.000-04:00
</code></pre>

<p>Itineraries are separated by the dashed lines.  This output, one must admit, is a bit terse and quite specific to the airline industry.  The first itinerary has a price of 941.70 Great British Pounds (GBP) and involves two Air France (AF) flights on June 22nd and two Delta (DL) flights on the way back to Paris on June 29th.  The next itinerary is (shocking!) about four times as expensive, 3594.70 GBP, and involves three carriers this time, UA (United Airlines), US (US Airways), and again Delta on the return.  Note that this outbound air journey has a connection in Charlotte, North Carolina, USA (CLT) instead of Atlanta, Georgia (ATL).</p>

<p>When run, the code <code>Lesson2</code> will produce a number of these itineraries plus prices for them&ndash;typically about 20.  There will be a pause at the time the program starts while it waits for the proposed, available itineraries to be returned from a TravelPort GDS.  At the time each itinerary is displayed there will also be a pause as that particular itinerary is priced.</p>

<h3>Outline</h3>

<p>At a high level, the class <a href="https://github.com/iansmith/travelport-uapi-tutorial/blob/master/src/com/travelport/uapi/unit1/Lesson2.java">Lesson2</a> must perform these logical operations:</p>

<ul>
<li>Construct the necessary parameters for an availability search, such as the origin and destination city as well as the travel dates</li>
<li>Make the availability search request</li>
<li>Decode the results of the search into proper itineraries</li>
<li>Looping over each itinerary

<ul>
<li>Request the price of this itinerary</li>
<li>Display the resulting price</li>
<li>Display the segments of the journey</li>
</ul></li>
</ul>

<p>As we shall see, the first and third items will prove to be more complex than most people would expect.</p>

<h3>Preparing the search</h3>

<p>At the beginning of <code>main()</code> in the <code>Lesson2</code> class are these lines:</p>

<pre><code class="java">
//make the request... paris to chattanooga TN USA
String from =&quot;CDG&quot;,to=&quot;CHA&quot;;
//staying a week ... two months from now.. roundtrip
AvailabilitySearchRsp rsp = search(from, to, 
    Helper.daysInFuture(60), Helper.daysInFuture(67));
</code></pre>

<p>The two calls to the helper method <code>Helper.daysInFuture()</code> should be fairly self explanatory.  So, we&rsquo;ve setup all we need for a search now, right? We have the origin, destination, and dates of travel, so we are ready, right?  Not by a long shot!  The method <code>search</code> is implemented in <code>Lesson2</code> and is dozens of lines of code plus uses a number of helper routines.  &ldquo;Why all this extra code?&rdquo;, one may wonder.  The reason is that there are hundreds of parameters that can possibly be set on an air search, for far too many reasons than can be explained here.  However, some of these parameters are required to be set in <em>any</em> air travel search done with uAPI such as the (obvious) origin and destination but also other details such as what type of passenger is traveling (Adult is our default choice, but there are more than 100 types of passengers such as Military Veteran, Member of the Clergy, etc).</p>

<p>Here is a snippet from the implementation of the <code>search()</code> method:</p>

<pre><code class="java">
//R/T journey
SearchAirLeg outbound = AirReq.createLeg(origin, dest);
AirReq.addDepartureDate(outbound, dateOut);
AirReq.addEconomyPreferred(outbound);

//coming back
SearchAirLeg ret = AirReq.createLeg(dest, origin);
AirReq.addDepartureDate(ret, dateBack);
//put traveller in econ
AirReq.addEconomyPreferred(ret);

</code></pre>

<p>The code above creates two &ldquo;legs&rdquo; for the search to consider: one outbound from <code>origin</code> to <code>dest</code> and one for the reverse (<code>ret</code>) one week later.  Each leg also has a departure date and what type of seat should be searched for.  Each line of this snippet with code on it uses a method from the <a href="https://github.com/iansmith/travelport-uapi-tutorial/blob/master/src/com/travelport/uapi/unit1/AirReq.java">AirReq</a> helper object.  These helper methods have been provided to try to make it easier to understand the examples or write new code that does similar things.</p>

<p>The <code>AirReq</code> class has no &ldquo;magic,&rdquo; of course.  This class is building various structures from the classes that were generated as part of our work with <code>Air.wsdl</code>.  For example:</p>

<pre><code class="java">
public static SearchAirLeg createLeg(String originAirportCode,
    String destAirportCode) {
    
    TypeSearchLocation originLoc = new TypeSearchLocation();
    TypeSearchLocation destLoc = new TypeSearchLocation();

    // airport objects are just wrappers for their codes
    Airport origin = new Airport(), dest = new Airport();
    origin.setCode(originAirportCode);
    dest.setCode(destAirportCode);
    
    // search locations can be things other than airports but we are using
    // the airport version...
    originLoc.setAirport(origin);
    destLoc.setAirport(dest);

    return createLeg(originLoc, destLoc);
    }
</code></pre>

<p>This is the code that creates a single <code>SearchAirLeg</code> object that is part of our request to the TravelPort uAPI for an availability search.  You can see from the code above that locations are more complicated objects than one might expect&hellip; they <em>can</em> be an airport code as in this example, or they can be more complex entities such as &ldquo;all locations near a given a city&rdquo; as we will see in Lesson 3.</p>

<p>It is worth the time look at the implementation of <code>AirReq</code> so that you can see, even for the relatively simple searches we are doing here the number of different options, and thus different classes and structures, that are used.</p>

<h3>Decoding The Result</h3>

<p>To understand the decoding taking place in the client code of Lesson 2, it may be useful to examine the XML that is actually returned via the network from the uAPI server to our client.  This example is edited for space:</p>

<pre><code class="xml"> &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;SOAP:Envelope xmlns:SOAP=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;
  &lt;SOAP:Body&gt;
    &lt;air:AvailabilitySearchRsp xmlns:air=&quot;http://www.travelport.com/schema/air_v18_0&quot; xmlns:common_v15_0=&quot;http://www.travelport.com/schema/common_v15_0&quot; TransactionId=&quot;E32DF18C0A07581501D13BB0BE67E3C8&quot; ResponseTime=&quot;965&quot; DistanceUnits=&quot;MI&quot;&gt;
      &lt;air:FlightDetailsList&gt;
        &lt;air:FlightDetails Key=&quot;0T&quot; Origin=&quot;CDG&quot; Destination=&quot;ATL&quot; DepartureTime=&quot;2012-06-23T10:55:00.000+02:00&quot; ArrivalTime=&quot;2012-06-23T14:20:00.000-04:00&quot; FlightTime=&quot;565&quot; TravelTime=&quot;722&quot; Equipment=&quot;77W&quot; OriginTerminal=&quot;2E&quot; DestinationTerminal=&quot;S&quot;/&gt;
        &lt;air:FlightDetails Key=&quot;1T&quot; Origin=&quot;ATL&quot; Destination=&quot;CHA&quot; DepartureTime=&quot;2012-06-23T16:05:00.000-04:00&quot; ArrivalTime=&quot;2012-06-23T16:57:00.000-04:00&quot; FlightTime=&quot;52&quot; TravelTime=&quot;722&quot; Equipment=&quot;CRJ&quot; OriginTerminal=&quot;S&quot;/&gt;
        &lt;air:FlightDetails Key=&quot;2T&quot; Origin=&quot;CDG&quot; Destination=&quot;ATL&quot; DepartureTime=&quot;2012-06-23T10:55:00.000+02:00&quot; ArrivalTime=&quot;2012-06-23T14:20:00.000-04:00&quot; FlightTime=&quot;565&quot; TravelTime=&quot;722&quot; Equipment=&quot;77W&quot; OriginTerminal=&quot;2E&quot; DestinationTerminal=&quot;S&quot;/&gt;
        &lt;air:FlightDetails Key=&quot;3T&quot; Origin=&quot;ATL&quot; Destination=&quot;CHA&quot; DepartureTime=&quot;2012-06-23T16:05:00.000-04:00&quot; ArrivalTime=&quot;2012-06-23T16:57:00.000-04:00&quot; FlightTime=&quot;52&quot; TravelTime=&quot;722&quot; Equipment=&quot;CRJ&quot; OnTimePerformance=&quot;70&quot; OriginTerminal=&quot;S&quot;/&gt;
        &lt;air:FlightDetails Key=&quot;4T&quot; Origin=&quot;CDG&quot; Destination=&quot;CLT&quot; DepartureTime=&quot;2012-06-23T11:10:00.000+02:00&quot; ArrivalTime=&quot;2012-06-23T14:35:00.000-04:00&quot; FlightTime=&quot;565&quot; TravelTime=&quot;743&quot; Equipment=&quot;767&quot; OriginTerminal=&quot;1&quot;/&gt;
        &lt;air:FlightDetails Key=&quot;5T&quot; Origin=&quot;CLT&quot; Destination=&quot;CHA&quot; DepartureTime=&quot;2012-06-23T16:25:00.000-04:00&quot; ArrivalTime=&quot;2012-06-23T17:33:00.000-04:00&quot; FlightTime=&quot;68&quot; TravelTime=&quot;743&quot; Equipment=&quot;CRJ&quot; OnTimePerformance=&quot;-10&quot;/&gt;
        &lt;air:FlightDetails Key=&quot;6T&quot; Origin=&quot;CDG&quot; Destination=&quot;CLT&quot; DepartureTime=&quot;2012-06-23T11:10:00.000+02:00&quot; ArrivalTime=&quot;2012-06-23T14:35:00.000-04:00&quot; FlightTime=&quot;565&quot; TravelTime=&quot;743&quot; Equipment=&quot;767&quot; OriginTerminal=&quot;1&quot;/&gt;
        &lt;air:FlightDetails Key=&quot;7T&quot; Origin=&quot;CLT&quot; Destination=&quot;CHA&quot; DepartureTime=&quot;2012-06-23T16:25:00.000-04:00&quot; ArrivalTime=&quot;2012-06-23T17:33:00.000-04:00&quot; FlightTime=&quot;68&quot; TravelTime=&quot;743&quot; Equipment=&quot;CRJ&quot; OnTimePerformance=&quot;-10&quot;/&gt;
      &lt;/air:FlightDetailsList&gt;
      &lt;air:AirSegmentList&gt;
        &lt;air:AirSegment Key=&quot;30T&quot; Group=&quot;0&quot; Carrier=&quot;AF&quot; FlightNumber=&quot;682&quot; Origin=&quot;CDG&quot; Destination=&quot;ATL&quot; DepartureTime=&quot;2012-06-23T10:55:00.000+02:00&quot; ArrivalTime=&quot;2012-06-23T14:20:00.000-04:00&quot; FlightTime=&quot;565&quot; TravelTime=&quot;722&quot; ETicketability=&quot;Yes&quot; Equipment=&quot;77W&quot; ChangeOfPlane=&quot;false&quot; ParticipantLevel=&quot;Secure Sell&quot; LinkAvailability=&quot;true&quot; PolledAvailabilityOption=&quot;Polled avail used&quot; OptionalServicesIndicator=&quot;false&quot; AvailabilitySource=&quot;Seamless&quot;&gt;
          &lt;air:AirAvailInfo ProviderCode=&quot;1G&quot;&gt;
            &lt;air:BookingCodeInfo BookingCounts=&quot;J9|ZC|W9|U9|TC|GR&quot;/&gt;
            &lt;air:BookingCodeInfo CabinClass=&quot;Business&quot; BookingCounts=&quot;C9|D7|IC&quot;/&gt;
            &lt;air:BookingCodeInfo CabinClass=&quot;Economy&quot; BookingCounts=&quot;OC|S9|Y9|B9|M9|K9|H9|LC|QC|EC|NC|RC|VC|XC&quot;/&gt;
            &lt;air:BookingCodeInfo CabinClass=&quot;PremiumEconomy&quot; BookingCounts=&quot;A5&quot;/&gt;
          &lt;/air:AirAvailInfo&gt;
          &lt;air:FlightDetailsRef Key=&quot;0T&quot;/&gt;
        &lt;/air:AirSegment&gt;
        &lt;air:AirSegment Key=&quot;31T&quot; Group=&quot;0&quot; Carrier=&quot;AF&quot; FlightNumber=&quot;8468&quot; Origin=&quot;ATL&quot; Destination=&quot;CHA&quot; DepartureTime=&quot;2012-06-23T16:05:00.000-04:00&quot; ArrivalTime=&quot;2012-06-23T16:57:00.000-04:00&quot; FlightTime=&quot;52&quot; TravelTime=&quot;722&quot; ETicketability=&quot;Yes&quot; Equipment=&quot;CRJ&quot; ChangeOfPlane=&quot;false&quot; ParticipantLevel=&quot;Secure Sell&quot; LinkAvailability=&quot;true&quot; PolledAvailabilityOption=&quot;Polled avail used&quot; OptionalServicesIndicator=&quot;false&quot; AvailabilitySource=&quot;Seamless&quot;&gt;
          &lt;air:CodeshareInfo OperatingCarrier=&quot;DL&quot;/&gt;
          &lt;air:AirAvailInfo ProviderCode=&quot;1G&quot;&gt;
            &lt;air:BookingCodeInfo BookingCounts=&quot;W9|U9|T9&quot;/&gt;
            &lt;air:BookingCodeInfo CabinClass=&quot;Economy&quot; BookingCounts=&quot;S9|Y9|B9|M9|K9|H9|V9|L9|Q9|N7|R7&quot;/&gt;
            &lt;air:BookingCodeInfo CabinClass=&quot;PremiumEconomy&quot; BookingCounts=&quot;A9&quot;/&gt;
          &lt;/air:AirAvailInfo&gt;
          &lt;air:FlightDetailsRef Key=&quot;1T&quot;/&gt;
        &lt;/air:AirSegment&gt;
        &lt;air:AirSegment Key=&quot;32T&quot; Group=&quot;0&quot; Carrier=&quot;DL&quot; FlightNumber=&quot;8504&quot; Origin=&quot;CDG&quot; Destination=&quot;ATL&quot; DepartureTime=&quot;2012-06-23T10:55:00.000+02:00&quot; ArrivalTime=&quot;2012-06-23T14:20:00.000-04:00&quot; FlightTime=&quot;565&quot; TravelTime=&quot;722&quot; ETicketability=&quot;Yes&quot; Equipment=&quot;77W&quot; ChangeOfPlane=&quot;false&quot; ParticipantLevel=&quot;Secure Sell&quot; LinkAvailability=&quot;true&quot; PolledAvailabilityOption=&quot;Polled avail used&quot; OptionalServicesIndicator=&quot;false&quot; AvailabilitySource=&quot;Seamless&quot;&gt;
          &lt;air:CodeshareInfo OperatingCarrier=&quot;AF&quot;/&gt;
          &lt;air:AirAvailInfo ProviderCode=&quot;1G&quot;&gt;
            &lt;air:BookingCodeInfo BookingCounts=&quot;J9|W5|U0|T0&quot;/&gt;
            &lt;air:BookingCodeInfo CabinClass=&quot;Business&quot; BookingCounts=&quot;C9|D7|I0&quot;/&gt;
            &lt;air:BookingCodeInfo CabinClass=&quot;Economy&quot; BookingCounts=&quot;S0|Y9|B9|M9|H9|Q9|K0|L0&quot;/&gt;
          &lt;/air:AirAvailInfo&gt;
          &lt;air:FlightDetailsRef Key=&quot;2T&quot;/&gt;
        &lt;/air:AirSegment&gt;
        &lt;air:AirSegment Key=&quot;33T&quot; Group=&quot;0&quot; Carrier=&quot;DL&quot; FlightNumber=&quot;5542&quot; Origin=&quot;ATL&quot; Destination=&quot;CHA&quot; DepartureTime=&quot;2012-06-23T16:05:00.000-04:00&quot; ArrivalTime=&quot;2012-06-23T16:57:00.000-04:00&quot; FlightTime=&quot;52&quot; TravelTime=&quot;722&quot; ETicketability=&quot;Yes&quot; Equipment=&quot;CRJ&quot; ChangeOfPlane=&quot;false&quot; ParticipantLevel=&quot;Secure Sell&quot; LinkAvailability=&quot;true&quot; PolledAvailabilityOption=&quot;Polled avail used&quot; OptionalServicesIndicator=&quot;false&quot; AvailabilitySource=&quot;Seamless&quot;&gt;
          &lt;air:AirAvailInfo ProviderCode=&quot;1G&quot;&gt;
            &lt;air:BookingCodeInfo CabinClass=&quot;Economy&quot; BookingCounts=&quot;Y9|B9|M9|H9|Q9|K9|L9|E3&quot;/&gt;
            &lt;air:BookingCodeInfo BookingCounts=&quot;U9|T9&quot;/&gt;
          &lt;/air:AirAvailInfo&gt;
          &lt;air:FlightDetailsRef Key=&quot;3T&quot;/&gt;
        &lt;/air:AirSegment&gt;
      &lt;/air:AirSegmentList&gt;
      &lt;air:AirItinerarySolution Key=&quot;60T&quot;&gt;
        &lt;air:AirSegmentRef Key=&quot;30T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;31T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;32T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;33T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;34T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;35T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;36T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;37T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;38T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;39T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;40T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;41T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;42T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;43T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;44T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;45T&quot;/&gt;
        &lt;air:Connection SegmentIndex=&quot;0&quot;/&gt;
        &lt;air:Connection SegmentIndex=&quot;2&quot;/&gt;
        &lt;air:Connection SegmentIndex=&quot;4&quot;/&gt;
        &lt;air:Connection SegmentIndex=&quot;6&quot;/&gt;
        &lt;air:Connection SegmentIndex=&quot;8&quot;/&gt;
        &lt;air:Connection SegmentIndex=&quot;10&quot;/&gt;
        &lt;air:Connection SegmentIndex=&quot;12&quot;/&gt;
        &lt;air:Connection SegmentIndex=&quot;14&quot;/&gt;
      &lt;/air:AirItinerarySolution&gt;
      &lt;air:AirItinerarySolution Key=&quot;61T&quot;&gt;
        &lt;air:AirSegmentRef Key=&quot;46T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;47T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;48T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;49T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;50T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;51T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;52T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;53T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;54T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;55T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;56T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;57T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;58T&quot;/&gt;
        &lt;air:AirSegmentRef Key=&quot;59T&quot;/&gt;
        &lt;air:Connection SegmentIndex=&quot;0&quot;/&gt;
        &lt;air:Connection SegmentIndex=&quot;2&quot;/&gt;
        &lt;air:Connection SegmentIndex=&quot;4&quot;/&gt;
        &lt;air:Connection SegmentIndex=&quot;6&quot;/&gt;
        &lt;air:Connection SegmentIndex=&quot;8&quot;/&gt;
        &lt;air:Connection SegmentIndex=&quot;9&quot;/&gt;
        &lt;air:Connection SegmentIndex=&quot;11&quot;/&gt;
        &lt;air:Connection SegmentIndex=&quot;12&quot;/&gt;
      &lt;/air:AirItinerarySolution&gt;
    &lt;/air:AvailabilitySearchRsp&gt;
  &lt;/SOAP:Body&gt;
&lt;/SOAP:Envelope&gt;
</code></pre>

<p>Let&rsquo;s explain the approach the uAPI is using to encode the results.  Each &ldquo;type&rdquo; of entity is detailed once, typically in a &ldquo;list&rdquo; of that type, for example the <code>air:FlightDetailsList</code> has many <code>air:FlightDetails</code> entities within it (and many more were clipped out for space reasons).  Similarly, the <code>air:AirSegmentList</code> contains many <code>air:AirSegment</code> encodings (again, we removed many <code>air:AirSegment</code> items for space).  However, it is important to note that <em>within</em> the <code>air:AirSegment</code>, the response does not repeat the <code>air:FlightDetails</code> but instead uses an <code>air:FlightDetailsRef</code> to refer to the flight details in question.  The <code>air:FlightDetailsRef</code> has a <code>Key</code> attribute that matches up with the <code>Key</code> attribute in the <code>air:FlightDetails</code>  object.  Why do it this way? Primarily, this approach avoids repetition which would bloat the already large requests and responses.  If you look at the last XML objects in the example you will see two &ldquo;solutions&rdquo; (<code>air:AirItinerarySolution</code>) that clearly indicate that it is possible to have a compact representation&hellip; after you have all the definitions above!  Interestingly, a single <code>air:ItinerarySolution</code> may encode many possible itineraries (despite the name) because it &ldquo;connects&rdquo; segments with the <code>air:Connection</code> entries.  We&rsquo;ll explain more about this later when discuss building &ldquo;routings.&rdquo;</p>

<p>The large size of these messages and the complexity of encoding and decoding them is one of the more serious complaints about SOAP/XML as a transport in systems such as the uAPI.  We will not debate that point here, but just mention that the requests and responses sent to and from the Travelport system often end up being hundreds of lines of XML.  If you are concerned about the size of the data being passed from your client to the TravelPort servers you can enable the gzip compression algorithm in the headers of your web requests with <code>Accept-Encoding: gzip, deflate</code>.</p>

<h3>Decoding Part 1: Building Maps</h3>

<p>For the tutorial, we have provided you with helper code to take a list, such as <code>air:FlightDetailsList</code>, and build a Java <code>HashMap</code> that maps all keys to the full <code>air:FlightDetails</code> objects.  This is handy to build first so when your are decoding something like the <code>air:AirItinerarySolution</code> you can easily get to the &ldquo;true&rdquo; objects being worked with.  Here is the part of the <code>main()</code> routine in <code>Lesson2</code> that builds the maps <code>allSegments</code> and <code>allDetails</code> from the response (<code>rsp</code>) to our availability search request:</p>

<pre><code class="java">//make tables that map the &quot;key&quot; (or a reference) to the proper
//segment and the proper flight details
Helper.AirSegmentMap allSegments = Helper.createAirSegmentMap(
        rsp.getAirSegmentList().getAirSegment());
Helper.FlightDetailsMap allDetails = Helper.createFlightDetailsMap(
        rsp.getFlightDetailsList().getFlightDetails());
</code></pre>

<p>It&rsquo;s worth noting in this example that to get access to the list of <code>air:AirSegment</code> objects in the result, the Java code is <code>getAirSegments().getAirSegment()</code>.  This peculiarity is tied to the way that CXF encodes the types expressed in the Air.wsdl file into a Java representation.</p>

<h3>Decoding Part 2: Air Solutions</h3>

<p>It would be handy if the results returned from an air availability search could be pulled out of the response and directly used as parameters back to the uAPI as all or part of a air price request.  Sadly, no such luck.  The availability search returns <em>many</em> possible solutions and these are encoded in a compact way, see <code>air:AirItinerarySolution</code> in the XML example above.  Conversely, the air price port requires that you supply a single itinerary, in the form of an <code>AirItinerary</code> object, for pricing.  Some of the pieces of an <code>AirItinerary</code> can be constructed from the pieces returned from the server to us, but most of the pieces of an <code>AirItinerary</code> have to be <em>derived</em> from the results we have obtained from the <code>AirAvailabilitySearchRsp</code>.</p>

<p>In our XML example above, we displayed exactly two <code>AirItinerarySolution</code> objects.  This is all that were present in the result because one <code>AirItinerarySolution</code> is returned for each &ldquo;leg&rdquo; of the journey that has been searched for.  In this case, our search was from CDG (Paris) to CHA (Chattanooga) on the first leg and the reverse for the way back.  The code in <code>main</code> that takes care of this small issue is :</p>

<pre><code class="java">//Each &quot;solution&quot; is for a particular part of the journey... on
//a round trip there will be two of thes
List&lt;AirItinerarySolution&gt; solutions = rsp.getAirItinerarySolution();
AirItinerarySolution outboundSolution = solutions.get(0);
AirItinerarySolution inboundSolution = solutions.get(1);
</code></pre>

<h3>Decoding Part 3: Building Routings</h3>

<p>A &ldquo;routing&rdquo; is a set a flights, in some order, that get the traveller from an origin to a destination.  This set has one element in the case of a direct flight, otherwise it has one or more &ldquo;connections&rdquo;.  The code for building the final &ldquo;routings&rdquo; is quite short in <code>main()</code> for <code>Lesson2</code>:</p>

<pre><code class="java">//bound the routings by using the connections
List&lt;AirItinerary&gt; out = buildRoutings(outboundSolution, allSegments, allDetails);
List&lt;AirItinerary&gt; in = buildRoutings(inboundSolution, allSegments, allDetails);
            
//merge in and out itins so we can get pricing for whole deal
List&lt;AirItinerary&gt; allItins = mergeOutboundAndInbound(out, in);
</code></pre>

<p>The functions <code>buildRoutings()</code> and <code>mergeOutboundAndInbound()</code> hide quite a bit of complexity.  Let&rsquo;s start by thinking about how to construct a routing from the XML.  From the example above, this is the outbound solution:</p>

<pre><code class="xml">&lt;air:AirItinerarySolution Key=&quot;60T&quot;&gt;
  &lt;air:AirSegmentRef Key=&quot;30T&quot;/&gt;
  &lt;air:AirSegmentRef Key=&quot;31T&quot;/&gt;
  &lt;air:AirSegmentRef Key=&quot;32T&quot;/&gt;
  &lt;air:AirSegmentRef Key=&quot;33T&quot;/&gt;
  &lt;air:AirSegmentRef Key=&quot;34T&quot;/&gt;
  &lt;air:AirSegmentRef Key=&quot;35T&quot;/&gt;
  &lt;air:AirSegmentRef Key=&quot;36T&quot;/&gt;
  &lt;air:AirSegmentRef Key=&quot;37T&quot;/&gt;
  &lt;air:AirSegmentRef Key=&quot;38T&quot;/&gt;
  &lt;air:AirSegmentRef Key=&quot;39T&quot;/&gt;
  &lt;air:AirSegmentRef Key=&quot;40T&quot;/&gt;
  &lt;air:AirSegmentRef Key=&quot;41T&quot;/&gt;
  &lt;air:AirSegmentRef Key=&quot;42T&quot;/&gt;
  &lt;air:AirSegmentRef Key=&quot;43T&quot;/&gt;
  &lt;air:AirSegmentRef Key=&quot;44T&quot;/&gt;
  &lt;air:AirSegmentRef Key=&quot;45T&quot;/&gt;
  &lt;air:Connection SegmentIndex=&quot;0&quot;/&gt;
  &lt;air:Connection SegmentIndex=&quot;2&quot;/&gt;
  &lt;air:Connection SegmentIndex=&quot;4&quot;/&gt;
  &lt;air:Connection SegmentIndex=&quot;6&quot;/&gt;
  &lt;air:Connection SegmentIndex=&quot;8&quot;/&gt;
  &lt;air:Connection SegmentIndex=&quot;10&quot;/&gt;
  &lt;air:Connection SegmentIndex=&quot;12&quot;/&gt;
  &lt;air:Connection SegmentIndex=&quot;14&quot;/&gt;
&lt;/air:AirItinerarySolution&gt;
</code></pre>

<p>It should be clear that this solution has a total of 16 air segments involved&hellip; so it&rsquo;s more than just a trip from Paris to Chattanooga via Atlanta!  The connections (<code>air:Connection</code>) at the bottom are the key to understanding what route takes one from Paris to Chattanooga.  The first air connection object indicates that index 0 of the list above, the air segment ref with key &ldquo;30T&rdquo; has a connection to the <em>next</em> air segment ref (key &ldquo;31T&rdquo;).  If we return to the very top of the XML example given previously and extract the <em>air segments</em> that are referred to by keys 30T and 31T we have:</p>

<pre><code class="xml">&lt;air:AirSegment Key=&quot;30T&quot; Group=&quot;0&quot; Carrier=&quot;AF&quot; FlightNumber=&quot;682&quot; Origin=&quot;CDG&quot; Destination=&quot;ATL&quot; DepartureTime=&quot;2012-06-23T10:55:00.000+02:00&quot; ArrivalTime=&quot;2012-06-23T14:20:00.000-04:00&quot; FlightTime=&quot;565&quot; TravelTime=&quot;722&quot; ETicketability=&quot;Yes&quot; Equipment=&quot;77W&quot; ChangeOfPlane=&quot;false&quot; ParticipantLevel=&quot;Secure Sell&quot; LinkAvailability=&quot;true&quot; PolledAvailabilityOption=&quot;Polled avail used&quot; OptionalServicesIndicator=&quot;false&quot; AvailabilitySource=&quot;Seamless&quot;&gt;
  &lt;air:AirAvailInfo ProviderCode=&quot;1G&quot;&gt;
    &lt;air:BookingCodeInfo BookingCounts=&quot;J9|ZC|W9|U9|TC|GR&quot;/&gt;
    &lt;air:BookingCodeInfo CabinClass=&quot;Business&quot; BookingCounts=&quot;C9|D7|IC&quot;/&gt;
    &lt;air:BookingCodeInfo CabinClass=&quot;Economy&quot; BookingCounts=&quot;OC|S9|Y9|B9|M9|K9|H9|LC|QC|EC|NC|RC|VC|XC&quot;/&gt;
    &lt;air:BookingCodeInfo CabinClass=&quot;PremiumEconomy&quot; BookingCounts=&quot;A5&quot;/&gt;
  &lt;/air:AirAvailInfo&gt;
  &lt;air:FlightDetailsRef Key=&quot;0T&quot;/&gt;
&lt;/air:AirSegment&gt;
&lt;air:AirSegment Key=&quot;31T&quot; Group=&quot;0&quot; Carrier=&quot;AF&quot; FlightNumber=&quot;8468&quot; Origin=&quot;ATL&quot; Destination=&quot;CHA&quot; DepartureTime=&quot;2012-06-23T16:05:00.000-04:00&quot; ArrivalTime=&quot;2012-06-23T16:57:00.000-04:00&quot; FlightTime=&quot;52&quot; TravelTime=&quot;722&quot; ETicketability=&quot;Yes&quot; Equipment=&quot;CRJ&quot; ChangeOfPlane=&quot;false&quot; ParticipantLevel=&quot;Secure Sell&quot; LinkAvailability=&quot;true&quot; PolledAvailabilityOption=&quot;Polled avail used&quot; OptionalServicesIndicator=&quot;false&quot; AvailabilitySource=&quot;Seamless&quot;&gt;
  &lt;air:CodeshareInfo OperatingCarrier=&quot;DL&quot;/&gt;
  &lt;air:AirAvailInfo ProviderCode=&quot;1G&quot;&gt;
    &lt;air:BookingCodeInfo BookingCounts=&quot;W9|U9|T9&quot;/&gt;
    &lt;air:BookingCodeInfo CabinClass=&quot;Economy&quot; BookingCounts=&quot;S9|Y9|B9|M9|K9|H9|V9|L9|Q9|N7|R7&quot;/&gt;
    &lt;air:BookingCodeInfo CabinClass=&quot;PremiumEconomy&quot; BookingCounts=&quot;A9&quot;/&gt;
  &lt;/air:AirAvailInfo&gt;
  &lt;air:FlightDetailsRef Key=&quot;1T&quot;/&gt;
&lt;/air:AirSegment&gt;
</code></pre>

<p>This shows the two flights needed to get from Paris to Chattanooga: Air France flight 682 (Carrier=&ldquo;AF&rdquo; and FlightNumber=&ldquo;682&rdquo;) from CDG to ATL and then Air France flight 8468.  Looking carefully at the second air segment here, you can see the <code>air:CodeShareInfo</code> element that identifies this second flight as a codeshare flight that is being operated by Delta (OperatingCarrier=&ldquo;DL&rdquo;).  So, if you were surprised that Air France had a flight from Atlanta to Chattanooga within the USA, you should feel better now!</p>

<p>This processing of using the <code>AirSolution</code> objects&rsquo; <code>Connection</code> objects to figure out the necessary <code>AirSegment</code> objects, taken from the maps built in &ldquo;Decoding Part 1&rdquo;, is the job of the function <code>buildRoutings()</code> shown earlier.  The routing result is an <code>AirItinerary</code> object with the correct legs in it for the particular outbound or inbound journey.  Since the routings for outbound and inbound are built separately&ndash;the <code>air:AirItinerarySolution</code> entities in the XML dictate this&ndash;we will need to combine the outbound and inbound itineraries (in the right order!) to form full itineraries.  Without this, we would be pricing the one way journeys either from Paris to Chattanooga or the reverse.</p>

<p>In <code>Lesson2</code>, the function <code>mergeOutboundAndInbound()</code> creates a Java <code>List</code> of all the combinations of outbound and return itineraries created by <code>buildRoutings()</code>.  This is done by creating every permutation (the cross product) of the two input lists of <code>AirItinerary</code> objects.</p>

<h3>Pricing</h3>

<p>After all this, we now have a <code>List&lt;AirItinerary&gt;</code> objects, with each element indicating a journey that is suitable for pricing.  As with any port we have discussed in this tutorial, we must first construct the correct request parameters, in this case <code>AirPricingReq</code>.  The <code>AirPricingReq</code> object has a few more things that are needed besides the itinerary, such as the cabin preference (in case multiple are available), the type of passenger, etc.  This is the critical part of the function <code>displayItineraryPrice</code> that does the work of calling the uAPI to get a price for an <code>AirItinerary</code>:</p>

<pre><code class="java">
public static void displayItineraryPrice(AirItinerary itin) throws AirFaultMessage {
    //now lets try to price it
    AirPriceReq priceReq = new AirPriceReq();
    AirPriceRsp priceRsp;
    
    //price the itinerary provided
    priceReq.setAirItinerary(itin);
    
    //set cabin
    AirPricingCommand command = new AirPricingCommand();
    command.setCabinClass(TypeCabinClass.ECONOMY);
    priceReq.getAirPricingCommand().add(command);
    
    //our branch
    priceReq.setTargetBranch(System.getProperty(&quot;travelport.targetBranch&quot;));
    
    //one adult passenger
    SearchPassenger adult = new SearchPassenger();
    adult.setCode(&quot;ADT&quot;);
    priceReq.getSearchPassenger().add(adult);
    
    //add point of sale (v18_0)
    AirReq.addPointOfSale(priceReq, &quot;tutorial-unit1-lesson2&quot;);
    
    //make the request to tport
    priceRsp = WSDLService.getPrice(false).service(priceReq);
</code></pre>

<h3>Woot!</h3>

<p>We have now completed the basic workflow that must be done to find a way to travel between two points via Air!  You should be able to run Lesson 2 the same way you ran Lesson 1 and have TravelPort price a few dozen or so possible itineraries for you.    As we will see in Lesson 3, there are other ways to do this work&hellip; and other ways to travel besides air!</p>

<h3>Exercises for the reader</h3>

<ul>
<li><p>Try changing the origin and destination airports to ones that you know well.  Look at the displayed itineraries and prices and compare to an online travel website.</p></li>

<li><p>Try using the <code>displayItineraryPrice</code> to compare the prices of two one-way journeys from the origin to the destination and the round trip price.  To do this you will need to construct &ldquo;one way&rdquo; itineraries (<code>AirItinerary</code>) and submit them to the pricing engine.</p></li>

<li><p>Try to improve the output of the program to be more descriptive and human-friendly.  This primarily means changing the loops in <code>displayItineraryPrice</code> and <code>main()</code> that walk the <code>AirPriceResult</code> and <code>AirItinerary</code> lists respectively.</p></li>

<li><p>Using a debugger, try stopping <code>Lesson2</code> around line 27.  Walk down the hierarchy of objects inside the <code>rsp</code> and explore what more information about the flights could be displayed for the user.  Similarly, stop the program around line 227 and do the same for the <code>priceRsp</code> to see what extra information could be displayed about the price.</p></li>
</ul>

<hr />

<p><a href="lesson3.html">Proceed To Lesson3</a></p>

</body>
</html>
